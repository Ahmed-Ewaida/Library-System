import 'package:dio/dio.dart';

import '../../local.dart'; // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­ ÙˆØ£Ù† LocalData.accessToken ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡.
import 'api_response.dart';
import 'endpoints.dart';

class ApiHelper {
  static final ApiHelper _singleton = ApiHelper._internal();

  factory ApiHelper() => _singleton;

  ApiHelper._internal();

  Dio dio =
      Dio(
          BaseOptions(
            baseUrl: Endpoints.baseUrl,
            connectTimeout: const Duration(
              seconds: 10,
            ), // Ø§Ø³ØªØ®Ø¯Ù… const Ù„Ù€ Duration
            receiveTimeout: const Duration(
              seconds: 10,
            ), // Ø§Ø³ØªØ®Ø¯Ù… const Ù„Ù€ Duration
          ),
        )
        ..interceptors.add(
          InterceptorsWrapper(
            onRequest: (options, handler) {
              // ignore: avoid_print
              print("Headers : ${options.headers.toString()}");
              // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙØ§Ø±ØºØ© ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ù„Ø·Ù„Ø¨Ø§Øª POST/PUT)
              if (options.data != null) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª FormData Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ø£Ù†ÙˆØ§Ø¹ Ø£Ø®Ø±Ù‰
                if (options.data is FormData) {
                  print(
                    "data : ${(options.data as FormData).fields.toString()}",
                  );
                } else {
                  print("data : ${options.data.toString()}");
                }
              }
              // ignore: avoid_print
              print("method : ${options.method}");
              // ignore: avoid_print
              print("EndPoint : ${options.path}");
              // ignore: avoid_print
              print(
                "Query Parameters : ${options.queryParameters.toString()}",
              ); // Ø£Ø¶Ù Ù‡Ø°Ø§ Ù„Ø·Ù„Ø¨Ø§Øª GET
              return handler.next(options); // ØªØ§Ø¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
            },
            // --- ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© onError interceptor Ù‡Ù†Ø§ ---
            onError: (DioException err, ErrorInterceptorHandler handler) {
              print("ğŸš¨ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø®Ø·Ø£ Dio ÙÙŠ Ø§Ù„Ù…ÙØ¹ØªØ±ÙØ¶:");
              print("Ø§Ù„Ù†ÙˆØ¹: ${err.type}");
              print("Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${err.message}");
              if (err.response != null) {
                print("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${err.response?.data}");
                print("ÙƒÙˆØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${err.response?.statusCode}");
              }
              return handler.next(err); // Ø§Ø³ØªÙ…Ø± ÙÙŠ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£
            },
          ),
        );

  // --- ØªÙ… ØªØµØ­ÙŠØ­ Ø·Ø±ÙŠÙ‚Ø© getRequest ---
  Future<ApiResponse> getRequest({
    required String url,
    Map<String, dynamic>? queryParameters, // Ø§Ø³ØªØ®Ø¯Ù… queryParameters Ù„Ù€ GET ÙÙ‚Ø·
    bool isAuthorized = false,
  }) async {
    try {
      var response = await dio.get(
        url,
        queryParameters: queryParameters, // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
        options: Options(
          headers: {
            if (isAuthorized)
              "Authorization":
                  "Bearer ${LocalData.accessToken}", // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
          },
        ),
      );
      return ApiResponse.fromResponse(response);
    } catch (e) {
      // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ApiResponse.fromError Ø¯ÙˆÙ† ØªØ­ÙˆÙŠÙ„ ØµØ±ÙŠØ­.
      // ApiResponse.fromError Ø³ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©.
      print("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ getRequest: $e");
      return ApiResponse.fromError(e);
    }
  }

  Future<ApiResponse> postRequest({
    required String endPoint,
    Map<String, dynamic>? data,
    bool isFormData = true,
    bool isAuthorized = true,
  }) async {
    try {
      var response = await dio.post(
        endPoint,
        data: isFormData ? FormData.fromMap(data ?? {}) : data,
        options: Options(
          headers: {
            if (isAuthorized)
              "Authorization": "Bearer ${LocalData.accessToken}",
          },
        ),
      );
      return ApiResponse.fromResponse(response);
    } catch (e) {
      // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©
      print("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ postRequest: $e");
      return ApiResponse.fromError(e);
    }
  }

  Future<ApiResponse> putRequest({
    required String url,
    dynamic data,
    bool isFormdata = true,
    bool isAuthorized = true,
  }) async {
    try {
      var response = await dio.put(
        url,
        data: isFormdata ? FormData.fromMap(data ?? {}) : data,
        options: Options(
          headers: {
            if (isAuthorized)
              "Authorization": "Bearer ${LocalData.accessToken}",
          },
        ),
      );
      return ApiResponse.fromResponse(response);
    } catch (e) {
      // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©
      print("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ putRequest: $e");
      return ApiResponse.fromError(e);
    }
  }

  Future<ApiResponse> deleteRequest({
    required String url,
    Map<String, dynamic>? data,
    bool isFormdata = true,
    bool isAuthorized = true,
  }) async {
    try {
      var response = await dio.delete(
        url,
        data: isFormdata ? FormData.fromMap(data ?? {}) : data,
        options: Options(
          headers: {
            if (isAuthorized)
              "Authorization": "Bearer ${LocalData.accessToken}",
          },
        ),
      );
      return ApiResponse.fromResponse(response);
    } catch (e) {
      // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©
      print("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ deleteRequest: $e");
      return ApiResponse.fromError(e);
    }
  }
}
